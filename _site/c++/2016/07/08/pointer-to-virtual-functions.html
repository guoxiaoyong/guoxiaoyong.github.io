<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>An Investigation On Pointers to Virtual Functions in C++</title>
  <meta name="description" content="Xiaoyong Guo">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.guoxiaoyong.com/c++/2016/07/08/pointer-to-virtual-functions.html">
  <link rel="alternate" type="application/rss+xml" title="Xiaoyong's Blog" href="http://www.guoxiaoyong.com/feed.xml">

  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
  </script>

  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
        });
  </script>

  <script type="text/javascript" async
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Xiaoyong's Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">An Investigation On Pointers to Virtual Functions in C++</h1>
    <p class="post-meta"><time datetime="2016-07-08T05:26:00-04:00" itemprop="datePublished">Jul 8, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><strong>Xiaoyong Guo</strong></p>

<p>I have noticed that if you print out 
the value of a pointer to a virtual function 
of a class using <code class="highlighter-rouge">printf("%p\n", ptr)</code>, 
the result is a <code class="highlighter-rouge">1</code>.
In contrast, 
the value of a pointer to a regular function 
or member function is something like <code class="highlighter-rouge">0x400606</code>.</p>

<p>In order to develop a better understanding of this phenomenon,
I designed a very simple class <code class="highlighter-rouge">A</code> as follows:</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre><span class="k">struct</span> <span class="n">A</span> <span class="p">{</span>

    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">fun</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">gun</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">hun</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">A</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">A</span><span class="o">::</span><span class="n">gun</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="mi">10</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">A</span><span class="o">::</span><span class="n">hun</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="mi">100</span><span class="p">;</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>In the following <code class="highlighter-rouge">main</code> function, 
the addresses of virtual functions of class <code class="highlighter-rouge">A</code>
are assigned to variables 
<code class="highlighter-rouge">p1</code>, <code class="highlighter-rouge">p2</code> and <code class="highlighter-rouge">p3</code>.
Then an instance <code class="highlighter-rouge">a</code> of class <code class="highlighter-rouge">A</code> is constructed,
a pointer <code class="highlighter-rouge">b</code> points to the variable <code class="highlighter-rouge">a</code> is defined.
After that, I use three different forms 
to call virtual functions.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="p">(</span><span class="n">A</span><span class="o">::*</span><span class="n">p1</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="n">A</span><span class="o">::*</span><span class="n">p2</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="n">A</span><span class="o">::*</span><span class="n">p3</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">A</span><span class="o">::</span><span class="n">fun</span><span class="p">;</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">A</span><span class="o">::</span><span class="n">gun</span><span class="p">;</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">A</span><span class="o">::</span><span class="n">hun</span><span class="p">;</span>

    <span class="n">A</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">A</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">;</span>

    <span class="n">a</span><span class="p">.</span><span class="n">fun</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span>
    <span class="n">b</span><span class="o">-&gt;</span><span class="n">gun</span><span class="p">(</span><span class="mi">23</span><span class="p">);</span>
    <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="o">*</span><span class="n">p3</span><span class="p">)(</span><span class="mi">24</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Then I type the following command to compile the C++ code
into x86 assembly code
(I just learned how to make g++ 
generate assembly code with intel syntax):</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">g++ -S -m32 -O0 -masm<span class="o">=</span>intel test.cc
<span class="c"># remove some irrelavant directives and demangle C++ symbols.</span>
cat test.s | grep -v cfi | grep -v .LF | c++filt &gt; result.s</code></pre></figure>

<p>The following is 
the resulting x86 assembly code 
(different versions of g++ seems to generate
somewhat different assembly code, my g++ version is v5.3.1):</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163</pre></td><td class="code"><pre>    <span class="p">.</span><span class="n">file</span>   <span class="s">"test.cc"</span>
    <span class="p">.</span><span class="n">intel_syntax</span> <span class="n">noprefix</span>
    <span class="p">.</span><span class="n">text</span>
    <span class="p">.</span><span class="n">align</span> <span class="mi">2</span>
    <span class="p">.</span><span class="n">globl</span>  <span class="n">A</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span>
    <span class="p">.</span><span class="n">type</span>   <span class="n">A</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="k">int</span><span class="p">),</span> <span class="err">@</span><span class="n">function</span>
<span class="n">A</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span><span class="o">:</span>
    <span class="k">push</span>    <span class="n">ebp</span>
    <span class="k">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">12</span><span class="err">]</span>
    <span class="k">add</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">pop</span> <span class="n">ebp</span>
    <span class="k">ret</span>
    <span class="p">.</span><span class="n">size</span>   <span class="n">A</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="k">int</span><span class="p">),</span> <span class="p">.</span><span class="o">-</span><span class="n">A</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span>
    <span class="p">.</span><span class="n">align</span> <span class="mi">2</span>
    <span class="p">.</span><span class="n">globl</span>  <span class="n">A</span><span class="o">::</span><span class="n">gun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span>
    <span class="p">.</span><span class="n">type</span>   <span class="n">A</span><span class="o">::</span><span class="n">gun</span><span class="p">(</span><span class="k">int</span><span class="p">),</span> <span class="err">@</span><span class="n">function</span>
<span class="n">A</span><span class="o">::</span><span class="n">gun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span><span class="o">:</span>
    <span class="k">push</span>    <span class="n">ebp</span>
    <span class="k">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">12</span><span class="err">]</span>
    <span class="k">add</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">10</span>
    <span class="k">pop</span> <span class="n">ebp</span>
    <span class="k">ret</span>
    <span class="p">.</span><span class="n">size</span>   <span class="n">A</span><span class="o">::</span><span class="n">gun</span><span class="p">(</span><span class="k">int</span><span class="p">),</span> <span class="p">.</span><span class="o">-</span><span class="n">A</span><span class="o">::</span><span class="n">gun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span>
    <span class="p">.</span><span class="n">align</span> <span class="mi">2</span>
    <span class="p">.</span><span class="n">globl</span>  <span class="n">A</span><span class="o">::</span><span class="n">hun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span>
    <span class="p">.</span><span class="n">type</span>   <span class="n">A</span><span class="o">::</span><span class="n">hun</span><span class="p">(</span><span class="k">int</span><span class="p">),</span> <span class="err">@</span><span class="n">function</span>
<span class="n">A</span><span class="o">::</span><span class="n">hun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span><span class="o">:</span>
    <span class="k">push</span>    <span class="n">ebp</span>
    <span class="k">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">12</span><span class="err">]</span>
    <span class="k">add</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">100</span>
    <span class="k">pop</span> <span class="n">ebp</span>
    <span class="k">ret</span>
    <span class="p">.</span><span class="n">size</span>   <span class="n">A</span><span class="o">::</span><span class="n">hun</span><span class="p">(</span><span class="k">int</span><span class="p">),</span> <span class="p">.</span><span class="o">-</span><span class="n">A</span><span class="o">::</span><span class="n">hun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span>
    <span class="p">.</span><span class="kr">section</span>    <span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">_ZN1AC2Ev</span><span class="p">,</span><span class="s">"axG"</span><span class="p">,</span><span class="err">@</span><span class="n">progbits</span><span class="p">,</span><span class="n">A</span><span class="o">::</span><span class="n">A</span><span class="p">(),</span><span class="n">comdat</span>
    <span class="p">.</span><span class="n">align</span> <span class="mi">2</span>
    <span class="p">.</span><span class="n">weak</span>   <span class="n">A</span><span class="o">::</span><span class="n">A</span><span class="p">()</span>
    <span class="p">.</span><span class="n">type</span>   <span class="n">A</span><span class="o">::</span><span class="n">A</span><span class="p">(),</span> <span class="err">@</span><span class="n">function</span>
<span class="n">A</span><span class="o">::</span><span class="n">A</span><span class="p">()</span><span class="o">:</span>
    <span class="k">push</span>    <span class="n">ebp</span>
    <span class="k">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">OFFSET</span> <span class="n">FLAT</span><span class="o">:</span><span class="n">vtable</span> <span class="n">for</span> <span class="n">A</span><span class="o">+</span><span class="mi">8</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">8</span><span class="err">]</span>
    <span class="k">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[eax],</span> <span class="n">edx</span>
    <span class="k">nop</span>
    <span class="k">pop</span> <span class="n">ebp</span>
    <span class="k">ret</span>
    <span class="p">.</span><span class="n">size</span>   <span class="n">A</span><span class="o">::</span><span class="n">A</span><span class="p">(),</span> <span class="p">.</span><span class="o">-</span><span class="n">A</span><span class="o">::</span><span class="n">A</span><span class="p">()</span>
    <span class="p">.</span><span class="n">weak</span>   <span class="n">A</span><span class="o">::</span><span class="n">A</span><span class="p">()</span>
    <span class="p">.</span><span class="n">set</span>    <span class="n">A</span><span class="o">::</span><span class="n">A</span><span class="p">(),</span><span class="n">A</span><span class="o">::</span><span class="n">A</span><span class="p">()</span>
    <span class="p">.</span><span class="n">text</span>
    <span class="p">.</span><span class="n">globl</span>  <span class="n">main</span>
    <span class="p">.</span><span class="n">type</span>   <span class="n">main</span><span class="p">,</span> <span class="err">@</span><span class="n">function</span>
<span class="n">main</span><span class="o">:</span>
    <span class="k">lea</span> <span class="n">ecx</span><span class="p">,</span> <span class="err">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="err">]</span>
    <span class="k">and</span> <span class="n">esp</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span>
    <span class="k">push</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ecx</span><span class="o">-</span><span class="mi">4</span><span class="err">]</span>
    <span class="k">push</span>    <span class="n">ebp</span>
    <span class="k">mov</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
    <span class="k">push</span>    <span class="n">edi</span>
    <span class="k">push</span>    <span class="n">esi</span>
    <span class="k">push</span>    <span class="n">ebx</span>
    <span class="k">push</span>    <span class="n">ecx</span>
    <span class="k">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">40</span>
    <span class="k">mov</span> <span class="n">esi</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">mov</span> <span class="n">edi</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">36</span><span class="err">]</span><span class="p">,</span> <span class="n">esi</span>
    <span class="k">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">32</span><span class="err">]</span><span class="p">,</span> <span class="n">edi</span>
    <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="mi">5</span>
    <span class="k">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">44</span><span class="err">]</span><span class="p">,</span> <span class="n">ecx</span>
    <span class="k">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">40</span><span class="err">]</span><span class="p">,</span> <span class="n">ebx</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">9</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">52</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">48</span><span class="err">]</span><span class="p">,</span> <span class="n">edx</span>
    <span class="k">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">12</span>
    <span class="k">lea</span> <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">56</span><span class="err">]</span>
    <span class="k">push</span>    <span class="n">eax</span>
    <span class="k">call</span>    <span class="n">A</span><span class="o">::</span><span class="n">A</span><span class="p">()</span>
    <span class="k">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">16</span>
    <span class="k">lea</span> <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">56</span><span class="err">]</span>
    <span class="k">mov</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">28</span><span class="err">]</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>
    <span class="k">push</span>    <span class="mi">22</span>
    <span class="k">lea</span> <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">56</span><span class="err">]</span>
    <span class="k">push</span>    <span class="n">eax</span>
    <span class="k">call</span>    <span class="n">A</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span>
    <span class="k">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">16</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">28</span><span class="err">]</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[eax]</span>
    <span class="k">add</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">4</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[eax]</span>
    <span class="k">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>
    <span class="k">push</span>    <span class="mi">23</span>
    <span class="k">push</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">28</span><span class="err">]</span>
    <span class="k">call</span>    <span class="n">eax</span>
    <span class="k">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">16</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">52</span><span class="err">]</span>
    <span class="k">and</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">test</span>    <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">jne</span> <span class="p">.</span><span class="n">L9</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">52</span><span class="err">]</span>
    <span class="k">jmp</span> <span class="p">.</span><span class="n">L10</span>
<span class="p">.</span><span class="n">L9</span><span class="o">:</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">48</span><span class="err">]</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">eax</span>
    <span class="k">lea</span> <span class="n">eax</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">56</span><span class="err">]</span>
    <span class="k">add</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edx</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[eax]</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">52</span><span class="err">]</span>
    <span class="k">sub</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">add</span> <span class="n">eax</span><span class="p">,</span> <span class="n">edx</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[eax]</span>
<span class="p">.</span><span class="n">L10</span><span class="o">:</span>
    <span class="k">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">48</span><span class="err">]</span>
    <span class="k">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">edx</span>
    <span class="k">lea</span> <span class="n">edx</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">56</span><span class="err">]</span>
    <span class="k">add</span> <span class="n">edx</span><span class="p">,</span> <span class="n">ecx</span>
    <span class="k">sub</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">8</span>
    <span class="k">push</span>    <span class="mi">24</span>
    <span class="k">push</span>    <span class="n">edx</span>
    <span class="k">call</span>    <span class="n">eax</span>
    <span class="k">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">16</span>
    <span class="k">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">lea</span> <span class="n">esp</span><span class="p">,</span> <span class="err">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">16</span><span class="err">]</span>
    <span class="k">pop</span> <span class="n">ecx</span>
    <span class="k">pop</span> <span class="n">ebx</span>
    <span class="k">pop</span> <span class="n">esi</span>
    <span class="k">pop</span> <span class="n">edi</span>
    <span class="k">pop</span> <span class="n">ebp</span>
    <span class="k">lea</span> <span class="n">esp</span><span class="p">,</span> <span class="err">[</span><span class="n">ecx</span><span class="o">-</span><span class="mi">4</span><span class="err">]</span>
    <span class="k">ret</span>
    <span class="p">.</span><span class="n">size</span>   <span class="n">main</span><span class="p">,</span> <span class="p">.</span><span class="o">-</span><span class="n">main</span>
    <span class="p">.</span><span class="n">weak</span>   <span class="n">vtable</span> <span class="n">for</span> <span class="n">A</span>
    <span class="p">.</span><span class="kr">section</span>    <span class="p">.</span><span class="n">rodata</span><span class="p">.</span><span class="n">_ZTV1A</span><span class="p">,</span><span class="s">"aG"</span><span class="p">,</span><span class="err">@</span><span class="n">progbits</span><span class="p">,</span><span class="n">vtable</span> <span class="n">for</span> <span class="n">A</span><span class="p">,</span><span class="n">comdat</span>
    <span class="p">.</span><span class="n">align</span> <span class="mi">4</span>
    <span class="p">.</span><span class="n">type</span>   <span class="n">vtable</span> <span class="n">for</span> <span class="n">A</span><span class="p">,</span> <span class="err">@</span><span class="n">object</span>
    <span class="p">.</span><span class="n">size</span>   <span class="n">vtable</span> <span class="n">for</span> <span class="n">A</span><span class="p">,</span> <span class="mi">20</span>
<span class="n">vtable</span> <span class="n">for</span> <span class="n">A</span><span class="o">:</span>
    <span class="p">.</span><span class="n">long</span>   <span class="mi">0</span>
    <span class="p">.</span><span class="n">long</span>   <span class="n">typeinfo</span> <span class="n">for</span> <span class="n">A</span>
    <span class="p">.</span><span class="n">long</span>   <span class="n">A</span><span class="o">::</span><span class="n">fun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span>
    <span class="p">.</span><span class="n">long</span>   <span class="n">A</span><span class="o">::</span><span class="n">gun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span>
    <span class="p">.</span><span class="n">long</span>   <span class="n">A</span><span class="o">::</span><span class="n">hun</span><span class="p">(</span><span class="k">int</span><span class="p">)</span>
    <span class="p">.</span><span class="n">weak</span>   <span class="n">typeinfo</span> <span class="n">for</span> <span class="n">A</span>
    <span class="p">.</span><span class="kr">section</span>    <span class="p">.</span><span class="n">rodata</span><span class="p">.</span><span class="n">_ZTI1A</span><span class="p">,</span><span class="s">"aG"</span><span class="p">,</span><span class="err">@</span><span class="n">progbits</span><span class="p">,</span><span class="n">typeinfo</span> <span class="n">for</span> <span class="n">A</span><span class="p">,</span><span class="n">comdat</span>
    <span class="p">.</span><span class="n">align</span> <span class="mi">4</span>
    <span class="p">.</span><span class="n">type</span>   <span class="n">typeinfo</span> <span class="n">for</span> <span class="n">A</span><span class="p">,</span> <span class="err">@</span><span class="n">object</span>
    <span class="p">.</span><span class="n">size</span>   <span class="n">typeinfo</span> <span class="n">for</span> <span class="n">A</span><span class="p">,</span> <span class="mi">8</span>
<span class="n">typeinfo</span> <span class="n">for</span> <span class="n">A</span><span class="o">:</span>
    <span class="p">.</span><span class="n">long</span>   <span class="n">vtable</span> <span class="n">for</span> <span class="n">__cxxabiv1</span><span class="o">::</span><span class="n">__class_type_info</span><span class="o">+</span><span class="mi">8</span>
    <span class="p">.</span><span class="n">long</span>   <span class="n">typeinfo</span> <span class="n">name</span> <span class="n">for</span> <span class="n">A</span>
    <span class="p">.</span><span class="n">weak</span>   <span class="n">typeinfo</span> <span class="n">name</span> <span class="n">for</span> <span class="n">A</span>
    <span class="p">.</span><span class="kr">section</span>    <span class="p">.</span><span class="n">rodata</span><span class="p">.</span><span class="n">_ZTS1A</span><span class="p">,</span><span class="s">"aG"</span><span class="p">,</span><span class="err">@</span><span class="n">progbits</span><span class="p">,</span><span class="n">typeinfo</span> <span class="n">name</span> <span class="n">for</span> <span class="n">A</span><span class="p">,</span><span class="n">comdat</span>
    <span class="p">.</span><span class="n">type</span>   <span class="n">typeinfo</span> <span class="n">name</span> <span class="n">for</span> <span class="n">A</span><span class="p">,</span> <span class="err">@</span><span class="n">object</span>
    <span class="p">.</span><span class="n">size</span>   <span class="n">typeinfo</span> <span class="n">name</span> <span class="n">for</span> <span class="n">A</span><span class="p">,</span> <span class="mi">3</span>
<span class="n">typeinfo</span> <span class="n">name</span> <span class="n">for</span> <span class="n">A</span><span class="o">:</span>
    <span class="p">.</span><span class="n">string</span> <span class="s">"1A"</span>
    <span class="p">.</span><span class="n">ident</span>  <span class="s">"GCC: (GNU) 5.3.1 20160406 (Red Hat 5.3.1-6)"</span>
    <span class="p">.</span><span class="kr">section</span>    <span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">GNU</span><span class="o">-</span><span class="n">stack</span><span class="p">,</span><span class="s">""</span><span class="p">,</span><span class="err">@</span><span class="n">progbits</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Keep in mind that <code class="highlighter-rouge">long</code> and <code class="highlighter-rouge">pointer type</code> 
are 32-bit long since I choose to 
generate 32-bit assembly code.</p>

<p>From line 67 to line 78, 
we can see that <code class="highlighter-rouge">p1 = 1</code>, <code class="highlighter-rouge">p2 = 5</code> and <code class="highlighter-rouge">p3 = 9</code>.
If I choose to generate 64-bit assembly code, you’ll see
that these three values are <code class="highlighter-rouge">1</code>, <code class="highlighter-rouge">9</code> and <code class="highlighter-rouge">17</code>.
So, it seems that the values stored in the 
pointers to virtual functions are 
<strong>offsets of virutual functions in the vtable plus 1</strong>. 
<code class="highlighter-rouge">vtable for A</code> is defined in line 142, 
where the first 8 bytes seems to be ignored when assigning
vtable address in the constructor of <code class="highlighter-rouge">A</code> in line 44.</p>

<p>Line 87-90 corresponds to the C++ code <code class="highlighter-rouge">a.fun(22)</code>. 
In line 90 the function address of <code class="highlighter-rouge">A::fun(int)</code> is called directly,
So we can conclude that there is no overhead incurred by 
calling a virtual function using the form <code class="highlighter-rouge">Object.Function</code>.</p>

<p>Line 92-99 corresponds to the C++ code <code class="highlighter-rouge">b-&gt;gun(23)</code>.  Line 92-95 
are the steps to get the address of the virtual 
function to be called from vtable. 
So call virtual function via a pointer to class <code class="highlighter-rouge">A</code>
incurs some overhead, 
4 additional instructions are needed to resolve
the address of the virtual function to be called.</p>

<p>Line 101-125 corresponds to the C++ code <code class="highlighter-rouge">a::*p3(24)</code>. 
We can see that this form of virtual function calling
is very expensive.
First you need to determine wether <code class="highlighter-rouge">p3</code> is a pointer
to a virtual function or a regular member function.
This is done by checking whether the value of <code class="highlighter-rouge">p3</code> is an odd number
or an even numer (line 102-103).
If the value is odd, then it is assumed 
that <code class="highlighter-rouge">p3</code> is a virtual function pointer 
(this is the reason for adding 1 to the offset).
To call the virtual function, you have to find the address of 
the function by looking up the vtable (line 108-116). 
Note that in line 114, the value of <code class="highlighter-rouge">p3</code> is substracted by 1
to get the offset.
If value in <code class="highlighter-rouge">p3</code> is an even number, 
then it is assumed that <code class="highlighter-rouge">p3</code> is 
a regular member function pointer. The value of <code class="highlighter-rouge">p3</code> is 
used as the function address to be called 
(line 105 and line 125).</p>

<h2 id="performance-test-results">Performance Test Results</h2>

<p>I did a simple performance benchmark.
The three function calls <code class="highlighter-rouge">a.fun(22)</code>, <code class="highlighter-rouge">b-&gt;fun(22)</code> and <code class="highlighter-rouge">a::*p1(22)</code> 
are iterated for <code class="highlighter-rouge">1e10</code> times.
The results are shown in the following table.</p>

<table>
  <thead>
    <tr>
      <th>Function Call</th>
      <th>Time (seconds)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">a.fun(22)</code></td>
      <td>84.475</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">b-&gt;fun(22)</code></td>
      <td>92.959</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">a::*p1(22)</code></td>
      <td>141.373</td>
    </tr>
  </tbody>
</table>

<h2 id="conclusions">Conclusions</h2>

<ol>
  <li>Pointer to a virtual function stores a value that equals to the offset of the virtual function in vtable plus 1.</li>
  <li>The calling form <code class="highlighter-rouge">Object.Function</code> incurs no overhead compared to calling a non-virtual function.</li>
  <li>The calling form <code class="highlighter-rouge">PtrToObject-&gt;Function</code> incurs a relatively small overhead.</li>
  <li>The calling form <code class="highlighter-rouge">Object.*PtrToFunction</code> incurs a relatively big overhead.</li>
</ol>

<p>Remember that <strong>item 3</strong> and <strong>item 4</strong> are based on the assumption that the g++ optimization switch is off. 
C++ compiler is able to optimize the generated assembly code to reduce this function calling overhead in many cases.</p>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Xiaoyong's Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Xiaoyong's Blog</li>
          <li><a href="mailto:guo.xiaoyong@gmail.com, guoxiaoyong@guoxiaoyong.com">guo.xiaoyong@gmail.com, guoxiaoyong@guoxiaoyong.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/guoxiaoyong"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">guoxiaoyong</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Guo Xiaoyong's blog
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
