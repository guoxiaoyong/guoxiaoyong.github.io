<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>LD_PRELOAD Environment Variable</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Xiaoyong's Blog </a></h1>
                <nav><ul>
                    <li><a href="/pages/welcome-to-xiaoyong-guos-homepage.html">Home</a></li>
                    <li><a href="/index.html">Blog</a></li>
                    <li><a href="/pages/projects.html">Projects</a></li>
                    <li><a href="/pages/about_xiaoyong_guo.html">About</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/ld_preload-environment-variable.html" rel="bookmark"
           title="Permalink to LD_PRELOAD Environment Variable">LD_PRELOAD Environment Variable</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>Mon 01 August 2016</span>

</footer><!-- /.post-info -->      <p><code>LD_PRELOAD</code> is a environment variable that affects the behavior of dynamic linker/loader. 
According to the man page of <code>ld.so(8)</code>:</p>
<blockquote>
<p><strong>LD_PRELOAD</strong>
A list of additional, user-specified, ELF shared objects to be loaded before all others.  The items of the list can be separated by spaces or colons.  This can be used to selectively override functions in other shared objects.  The objects are searched for using the rules given under DESCRIPTION.  In secure-execution mode, preload pathnames containing slashes are ignored, and shared objects in the standard search directories are loaded only if the set-user-ID mode bit is enabled on the shared object file.</p>
</blockquote>
<p><code>LD_PRELOAD</code> can be used to do various hacks. For example:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="kt">char</span> <span class="n">passwd</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;password&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage: %s password</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">passwd</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Correct Password!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid Password!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Compile the above code into a binary executable called <strong>pass</strong>,
if you type the following command, you will get the message "Invalid Password!"</p>
<div class="highlight"><pre><span></span>./pass hello
</pre></div>


<p>Let's write a simple <code>strcmp</code> function:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">strcmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s2</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;hack function invoked. s1=&lt;%s&gt; s2=&lt;%s&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Compile the above code into a <code>so</code> library <code>strcmp.so</code>, then set the environment
<code>LD_PRELOAD</code>, the <code>./pass hello</code> again, you will get the message "Correct Password!".</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://52.193.207.59/blog/">Leon's Blog</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="http://www.github.com/guoxiaoyong">github</a></li>
                            <li><a href="http://twitter.com">twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->


        <footer id="contentinfo" class="body">
           <p>guoxiaoyong@guoxiaoyong.com</p>
        </footer><!-- /#contentinfo -->

  <div style="margin:auto;display:inline-block;width:400px;text-align:center"><script type="text/javascript" src="//rf.revolvermaps.com/0/0/7.js?i=5d2dt1ex4s6&amp;m=0&amp;c=ff0000&amp;cr1=ffffff&amp;sx=0" async="async"></script></div>


</body>
</html>